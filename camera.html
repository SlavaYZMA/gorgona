<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <title>Горгона — запись глаз</title>
  <style>
    body,html{margin:0;padding:0;height:100%;background:#000;overflow:hidden;font-family:system-ui,sans-serif;color:#fff}
    #video{position:fixed;top:0;left:0;width:100%;height:100%;object-fit:cover;transform:scaleX(-1)}
    #overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.97);pointer-events:none}
    #frame{
      position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
      width:512px;height:128px;border:6px solid #fff;border-radius:18px;
      overflow:hidden;box-shadow:0 0 80px 30px rgba(255,255,255,0.7);
      pointer-events:none
    }
    #timer{position:fixed;top:120px;width:100%;text-align:center;font-size:80px;font-weight:bold;color:#0f0;opacity:0}
    #info{position:fixed;bottom:140px;width:100%;text-align:center;font-size:26px}
    button{
      position:fixed;bottom:30px;width:calc(50%-20px);padding:20px;
      font-size:22px;border:none;border-radius:14px;cursor:pointer;display:none
    }
    #retry{left:10px;background:#c00;color:#fff}
    #send{right:10px;background:#0a0;color:#fff}
  </style>
</head>
<body>

<video id="video" autoplay playsinline muted></video>
<div id="overlay"></div>
<div id="frame"></div>

<div id="timer">3</div>
<div id="info">Разреши камеру → пальцами увеличь глаза до рамки<br>Держи неподвижно 3 секунды</div>

<button id="retry">Перезаписать</button>
<button id="send">Отправить в Горгону</button>

<script>
  const video  = document.getElementById('video');
  const timer  = document.getElementById('timer');
  const info   = document.getElementById('info');
  const retry  = document.getElementById('retry');
  const send   = document.getElementById('send');

  let recorder, chunks = [];

  async function go() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "user" },
        audio: false
      });
      video.srcObject = stream;
      video.play();

      // Через 2 секунды после разрешения камеры — начинаем отсчёт
      setTimeout(() => {
        timer.style.opacity = 1;
        let n = 3;
        const iv = setInterval(() => {
          n--;
          timer.textContent = n || "Запись!";
          if (n < 0) && clearInterval(iv) && record();
        }, 1000);
      }, 2000);

    } catch(e) {
      info.innerHTML = "Камера не включена<br>Обнови страницу и разреши доступ";
    }
  }

  function record() {
    chunks = [];
    // Записываем ТОЛЬКО то, что видно внутри рамки 512×128
    const canvas = document.createElement('canvas');
    canvas.width  = 512;
    canvas.height = 128;
    const ctx = canvas.getContext('2d');

    const stream = canvas.captureStream(30);
    recorder = new MediaRecorder(stream, {mimeType:'video/webm;codecs=vp9'});

    recorder.ondataavailable = e => chunks.push(e.data);
    recorder.onstop = () => {
      const blob = new Blob(chunks, {type:'video/webm'});
      const url = URL.createObjectURL(blob);

      const prev = document.createElement('video');
      prev.src = url; prev.controls = true; prev.loop = true;
      prev.style = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:512px;height:128px;border:6px solid #fff;border-radius:18px;z-index:999';
      document.body.appendChild(prev);

      info.textContent = "Готово — только глаза";
      retry.style.display = send.style.display = 'block';
      retry.onclick = () => location.reload();
      send.onclick  = () => alert("Видео глаз готово!\nСкоро добавим загрузку в Filebase");
    };

    // Каждые 50 мс копируем видимую часть видео в canvas
    const draw = () => {
      const rect = document.getElementById('frame').getBoundingClientRect();
      ctx.drawImage(
        video,
        rect.left, rect.top, rect.width, rect.height,
        0, 0, 512, 128
      );
      if (recorder.state === "recording") requestAnimationFrame(draw);
    };
    draw();

    recorder.start();
    setTimeout(() => recorder.stop(), 5000);
  }

  go();
</script>
</body>
</html>
