<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Горгона — запись взгляда</title>
<style>
  body,html{margin:0;padding:0;height:100%;background:#000;color:#fff;font-family:system-ui,sans-serif;overflow:hidden;position:relative}
  #container{position:relative;width:100vw;height:100vh}
  #hiddenVideo{position:absolute;opacity:0;pointer-events:none}
  #visibleCanvas{display:block;margin:0 auto;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);border:5px solid white;border-radius:16px;box-shadow:0 0 60px rgba(255,255,255,0.3)}
  .text{position:absolute;bottom:100px;left:50%;transform:translateX(-50%);font-size:20px;text-align:center;width:90%;line-height:1.4}
  button{position:absolute;bottom:30px;padding:14px 32px;font-size:18px;border:none;border-radius:12px;cursor:pointer;transform:translateX(-50%)}
  #recordBtn{left:50%;background:#c00;color:white}
  #backBtn{left:80px;background:#333;color:white}
  #countdown{font-size:120px;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:none;opacity:0}
  #rec{font-size:24px;position:absolute;top:80px;left:50%;transform:translateX(-50%);opacity:0;color:#f44}
  #previewVideo{display:block;margin:0 auto;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);border:5px solid white;border-radius:16px}
</style>
</head>
<body>

<div id="container">
  <video id="hiddenVideo" autoplay playsinline muted></video>
  <canvas id="visibleCanvas" width="512" height="128"></canvas>

  <div class="text" id="instruction">
    Поднесите устройство так, чтобы <b>глаза</b> полностью заполнили белую рамку.<br>
    В кадре не должно быть ничего кроме глаз.
  </div>

  <button id="recordBtn">Записать</button>
  <button id="backBtn" onclick="history.back()">Назад</button>

  <div id="countdown">3</div>
  <div id="rec">REC</div>

  <video id="previewVideo" loop muted playsinline style="display:none"></video>
</div>

<script>
// ======== 1. Скрытый полный поток + видимый кроп-канвас ========
const video = document.getElementById('hiddenVideo');
const canvas = document.getElementById('visibleCanvas');
const ctx = canvas.getContext('2d');
let stream = null;

// ======== 2. Запуск фронтальной камеры ========
navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false })
  .then(s => {
    stream = s;
    video.srcObject = stream;
    video.play();
    drawLoop();
  })
  .catch(err => {
    alert("Не удалось получить доступ к камере. Разреши доступ и перезагрузи страницу.");
  });

// ======== 3. Рисуем в реальном времени только кроп 512×128 на видимом canvas ========
function drawLoop() {
  if (video.readyState === video.HAVE_ENOUGH_DATA) {
    // вычисляем координаты, чтобы центрировать лицо
    const scale = Math.max(canvas.width / video.videoWidth, canvas.height / video.videoHeight);
    const w = video.videoWidth * scale;
    const h = video.videoHeight * scale;
    const x = (video.videoWidth - canvas.width / scale) / 2;
    const y = (video.videoHeight - canvas.height / scale) / 2;

    ctx.drawImage(video, x, y, video.videoWidth - 2*x, video.videoHeight - 2*y, 0, 0, canvas.width, canvas.height);
  }
  requestAnimationFrame(drawLoop);
}

// ======== 4. Запись ровно 3 секунды только из canvas (то, что видит пользователь) ========
let recorder = null;
let chunks = [];

function startRecording() {
  const streamFromCanvas = canvas.captureStream(30); // 30 fps
  recorder = new MediaRecorder(streamFromCanvas, { mimeType: 'video/webm;codecs=vp9' });

  recorder.ondataavailable = e => chunks.push(e.data);
  recorder.onstop = () => {
    const blob = new Blob(chunks, { type: 'video/webm' });
    showPreview(blob);
    chunks = [];
  };

  // 3…2…1
  let count = 3;
  const countdownEl = document.getElementById('countdown');
  countdownEl.style.opacity = 1;
  countdownEl.textContent = count;
  const interval = setInterval(() => {
    count--;
    if(count > 0) countdownEl.textContent = count;
    else {
      clearInterval(interval);
      countdownEl.style.opacity = 0;
      document.getElementById('rec').style.opacity = 1;
      recorder.start();
      setTimeout(() => {
        recorder.stop();
        document.getElementById('rec').style.opacity = 0;
      }, 3000);
    }
  }, 1000);
}

// ======== 5. Превью и кнопки ========
function showPreview(blob) {
  const previewVideo = document.getElementById('previewVideo');
  previewVideo.src = URL.createObjectURL(blob);
  previewVideo.style.display = 'block';
  previewVideo.play();

  canvas.style.display = 'none';
  document.getElementById('instruction').style.display = 'none';
  document.getElementById('recordBtn').style.display = 'none';

  // кнопки превью
  const div = document.createElement('div');
  div.innerHTML = `
    <button onclick="accept()">Далее</button>
    <button onclick="retake()" style="margin-left:20px;background:#333">Записать заново</button>
    <button onclick="history.back()" style="margin-left:20px;background:#333">Назад</button>
  `;
  div.style.position = 'absolute';
  div.style.bottom = '40px';
  div.style.left = '50%';
  div.style.transform = 'translateX(-50%)';
  document.body.appendChild(div);

  window.currentBlob = blob; // сохраняем для отправки
}

// ======== 6. Повтор / Назад ========
function retake() { location.reload(); }

// ======== 7. Принять и отправить на полотно ========
async function accept() {
  const form = new FormData();
  form.append('file', window.currentBlob, 'eyes.webm');

  const resp = await fetch('/.netlify/functions/add-eyes', {
    method: 'POST',
    body: form
  });
  const json = await resp.json();

  if(json.deleteUrl){
    alert("Взгляд добавлен навсегда.\n\nСсылка для удаления (сохрани её!):\n" + json.deleteUrl);
    location.href = 'canvas.html';
  } else {
    alert('Ошибка: ' + JSON.stringify(json));
  }
}

// ======== 8. Кнопка записи ========
document.getElementById('recordBtn').onclick = startRecording;
</script>
</body>
</html>
