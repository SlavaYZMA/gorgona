<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Горгона — запись глаз</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface@0.0.7"></script>
  <style>
    body, html { margin:0; padding:0; height:100%; background:#000; color:#fff; font-family:system-ui,sans-serif; overflow:hidden; }
    .back { position:fixed; top:20px; left:20px; font-size:28px; color:#888; cursor:pointer; z-index:100; }
    .title { text-align:center; padding-top:40px; font-size:32px; margin-bottom:30px; }
    .container { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); text-align:center; }
    #frame { width:512px; height:128px; border:2px solid #fff; border-radius:12px; position:relative; }
    #video { width:512px; height:128px; object-fit:cover; border-radius:12px; display:block; }
    #timer { font-size:120px; margin-top:30px; color:#fff; }
    #previewVideo { width:512px; height:128px; border:2px solid #fff; border-radius:12px; margin-top:20px; }
    button { padding:16px 32px; margin:15px; font-size:20px; background:#fff; color:#000; border:none; border-radius:8px; cursor:pointer; }
    button:hover { background:#ddd; }
    .hidden { display:none; }
  </style>
</head>
<body>

  <div class="back" onclick="window.location.href='index.html'">←</div>
  <div class="title">Поднеси глаза к рамке и держи взгляд</div>

  <div class="container" id="recordSection">
    <div id="frame">
      <video id="video" autoplay playsinline muted></video>
    </div>
    <div id="timer">7</div>
  </div>

  <div class="container hidden" id="previewSection">
    <div id="previewVideo" controls loop></div>
    <div style="margin-top:30px;">
      <button onclick="restart()">ЗАПИСАТЬ ЗАНОВО</button>
      <button onclick="saveForever()">ОСТАВИТЬ НАВСЕГДА</button>
      <button onclick="downloadVideo()">СКАЧАТЬ НА КОМПЬЮТЕР</button>
    </div>
  </div>

  <script>
    const video = document.getElementById('video');
    const timerEl = document.getElementById('timer');
    const recordSection = document.getElementById('recordSection');
    const previewSection = document.getElementById('previewSection');
    const previewVideo = document.getElementById('previewVideo');

    let stream = null;
    let mediaRecorder = null;
    let recordedChunks = [];
    let timer = 7;
    let timerInterval = null;
    let detectionInterval = null;
    let model = null;
    let isRecording = false;
    let hasEyes = false;
    let closedEyesStart = null;

    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ 
          video: { width: 512, height: 128, facingMode: "user" }, 
          audio: false 
        });
        video.srcObject = stream;
        video.play();

        // Загружаем модель BlazeFace (лёгкая и работает везде)
        model = await blazeface.load();

        detectionInterval = setInterval(detectEyes, 100);
      } catch (err) {
        alert("Не удалось получить доступ к камере. Разреши доступ и обнови страницу.");
        console.error(err);
      }
    }

    function detectEyes() {
      if (!model || isRecording) return;

      model.estimateFaces(video, false).then(predictions => {
        if (predictions.length === 0) {
          resetTimer();
          return;
        }

        const landmarks = predictions[0].landmarks;
        const leftEye = landmarks[0];   // левый глаз
        const rightEye = landmarks[1];  // правый глаз

        const eyeCenterX = (leftEye[0] + rightEye[0]) / 2;
        const eyeCenterY = (leftEye[1] + rightEye[1]) / 2;
        const eyeDistance = Math.abs(rightEye[0] - leftEye[0]);

        // Проверяем, что глаза в центре рамки и достаточно крупные
        const inFrame = eyeCenterX > 150 && eyeCenterX < 362 && 
                        eyeCenterY > 30 && eyeCenterY < 98 &&
                        eyeDistance > 80 && eyeDistance < 180;

        // Примерная проверка закрытых глаз
        const top = predictions[0].topLeft[1];
        const bottom = predictions[0].bottomRight[1];
        const eyeHeight = bottom - top;
        const isClosed = eyeHeight < 50;

        if (isClosed) {
          if (!closedEyesStart) closedEyesStart = Date.now();
          else if (Date.now() - closedEyesStart > 1500) {
            resetTimer();
            return;
          }
        } else {
          closedEyesStart = null;
        }

        if (inFrame && !hasEyes) {
          hasEyes = true;
          startTimer();
        } else if (!inFrame && hasEyes) {
          resetTimer();
        }
      });
    }

    function startTimer() {
      if (timerInterval) return;
      timer = 7;
      timerEl.textContent = timer;
      timerInterval = setInterval(() => {
        timer--;
        timerEl.textContent = timer;
        if (timer <= 0) {
          clearInterval(timerInterval);
          timerInterval = null;
          finishRecording();
        }
      }, 1000);

      // Начинаем запись
      recordedChunks = [];
      const options = { mimeType: 'video/webm;codecs=vp9' };
      if (!MediaRecorder.isTypeSupported(options.mimeType)) {
        options.mimeType = 'video/webm';
      }
      mediaRecorder = new MediaRecorder(stream, options);
      mediaRecorder.ondataavailable = e => recordedChunks.push(e.data);
      mediaRecorder.start();
      isRecording = true;
    }

    function resetTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      timer = 7;
      timerEl.textContent = "7";
      hasEyes = false;
      if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
        isRecording = false;
      }
    }

    function finishRecording() {
      mediaRecorder.stop();
      isRecording = false;

      const blob = new Blob(recordedChunks, { type: 'video/webm' });
      const url = URL.createObjectURL(blob);
      previewVideo.src = url;

      recordSection.classList.add('hidden');
      previewSection.classList.remove('hidden');
    }

    function restart() {
      previewSection.classList.add('hidden');
      recordSection.classList.remove('hidden');
      startCamera();
    }

    function downloadVideo() {
      const blob = new Blob(recordedChunks, { type: 'video/webm' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'gorgona-eyes.webm';
      a.click();
    }

    function saveForever() {
      const blob = new Blob(recordedChunks, { type: 'video/webm' });
      const formData = new FormData();
      formData.append('file', blob, 'eyes.webm');

      // Заглушка — в будущем здесь будет Netlify Function
      fetch('/.netlify/functions/upload', {
        method: 'POST',
        body: formData
      })
      .then(res => res.json())
      .then(data => {
        console.log('Успешно загружено:', data);
        alert('Твои глаза теперь смотрят на мир вечно.');
      })
      .catch(err => {
        console.error(err);
        alert('Ошибка загрузки. Попробуй позже.');
      });
    }

    // Запуск
    startCamera();
  </script>
</body>
</html>
