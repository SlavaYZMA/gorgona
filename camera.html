<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Горгона — твой взгляд</title>
  <style>
    body,html{margin:0;padding:0;height:100%;background:#000;color:#fff;font-family:system-ui,sans-serif;overflow:hidden}
    #container{position:relative;width:100vw;height:100vh}
    #video{width:100vw;height:100vh;object-fit:cover;filter:brightness(1.1);transform:scaleX(-1)}
    #mask{position:absolute;top:0;left:0;width:100%;height:100%;background:#000;pointer-events:none}
    #frame{width:512px;height:128px;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);border:5px solid #fff;border-radius:16px;box-shadow:0 0 60px rgba(255,255,255,0.6);z-index:10}
    #preview{display:none;width:512px;height:128px;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);border:4px solid #0f0;border-radius:12px;z-index:20;background:#000}
    .controls{position:fixed;bottom:40px;left:50%;transform:translateX(-50%);z-index:30;text-align:center}
    button{padding:16px 32px;margin:10px;font-size:20px;border:none;border-radius:12px;cursor:pointer;min-width:200px}
    #record{background:#900;color:#fff}
    #save{background:#0a0;color:#fff;display:none}
    #delete{background:#c00;color:#fff;display:none}
    #canvasBtn{background:#fff;color:#000;display:none}
    #timer{font-size:80px;position:fixed;top:50%;left:50%;transform:translate(-50%,80px);opacity:0;z-index:15;color:#0f0}
    #back{position:fixed;top:30px;left:30px;background:#333;color:#fff;padding:10px 20px;border:none;border-radius:8px;cursor:pointer;z-index:30}
  </style>
</head>
<body>

<div id="container">
  <video id="video" autoplay playsinline></video>
  <div id="mask"></div>
  <div id="frame"></div>
  <canvas id="preview" width="512" height="128"></canvas>
  <div id="timer">3</div>
</div>

<div class="controls">
  <button id="record">ЗАПИСЬ</button><br>
  <button id="save">СОХРАНИТЬ НАВСЕГДА</button><br>
  <button id="delete">УДАЛИТЬ</button><br>
  <button id="canvasBtn">ПОСМОТРЕТЬ НА ВСЕ ГЛАЗА</button>
</div>

<button id="back" onclick="history.back()">← НАЗАД</button>

<script>
const video = document.getElementById('video');
const preview = document.getElementById('preview');
const ctx = preview.getContext('2d');
const timerEl = document.getElementById('timer');
const recordBtn = document.getElementById('record');
const saveBtn = document.getElementById('save');
const deleteBtn = document.getElementById('delete');
const canvasBtn = document.getElementById('canvasBtn');

let stream = null;
let finalBlob = null;
let deleteUrl = null;

// включаем камеру
navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } })
  .then(s => { stream = s; video.srcObject = stream; })
  .catch(() => alert("Камера не работает. Разреши доступ."));

recordBtn.onclick = () => {
  let sec = 3;
  timerEl.style.opacity = 1;
  timerEl.textContent = sec;
  
  const interval = setInterval(() => {
    sec--;
    timerEl.textContent = sec;
    if(sec <= 0){
      clearInterval(interval);
      timerEl.style.opacity = 0;
      captureFrame();
    }
  }, 1000);
};

function captureFrame() {
  ctx.drawImage(video, (video.videoWidth-512)/2, (video.videoHeight-128)/2, 512, 128, 0, 0, 512, 128);
  preview.style.display = 'block';
  
  preview.toBlob(blob => {
    finalBlob = blob;
  });
  
  recordBtn.style.display = 'none';
  saveBtn.style.display = 'inline-block';
  deleteBtn.style.display = 'inline-block';
  canvasBtn.style.display = 'inline-block';
}

saveBtn.onclick = async () => {
  if(!finalBlob) return;
  
  const form = new FormData();
  form.append('file', finalBlob, 'eyes.png');
  
  const resp = await fetch('/.netlify/functions/add-eyes', { method: 'POST', body: form });
  const json = await resp.json();
  
  if(json.deleteUrl){
    deleteUrl = json.deleteUrl;
    alert("Твои глаза добавлены навсегда.\n\nТолько по этой ссылке можно удалить:\n" + deleteUrl);
    canvasBtn.click();
  } else {
    alert("Ошибка: " + JSON.stringify(json));
  }
};

deleteBtn.onclick = () => {
  finalBlob = null;
  deleteUrl = null;
  ctx.clearRect(0,0,512,128);
  preview.style.display = 'none';
  recordBtn.style.display = 'inline-block';
  saveBtn.style.display = 'none';
  deleteBtn.style.display = 'none';
  canvasBtn.style.display = 'none';
};

canvasBtn.onclick = () => location.href = 'canvas.html';
</script>
</body>
</html>
