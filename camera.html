<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Запись глаз - ГОРГОНА</title>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4/face_mesh.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/aws-sdk@2.1251.0/dist/aws-sdk.min.js"></script>
  <script src="config.js"></script>
  <style>
    body, html { margin:0; padding:0; height:100%; background:#000; color:#fff; font-family:system-ui,sans-serif; overflow:hidden; }
    .center { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); text-align:center; }
    #title { font-size:32px; margin-bottom:20px; }
    #frame { width:512px; height:128px; border:2px solid white; border-radius:12px; position:relative; overflow:hidden; }
    #video { width:100%; height:100%; object-fit:cover; }
    #timer { font-size:120px; margin-top:20px; }
    .back { position:absolute; top:20px; left:20px; color:gray; font-size:24px; cursor:pointer; }
    #preview { width:512px; height:128px; border:2px solid white; border-radius:12px; margin-bottom:20px; }
    button { padding:10px 20px; margin:10px; font-size:20px; cursor:pointer; border:none; border-radius:8px; }
    #restart { background:#900; color:white; }
    #save { background:white; color:black; }
    #download { background:gray; color:white; }
    #qr { margin-top:20px; font-size:16px; }
  </style>
</head>
<body>
  <div class="back" onclick="history.back()">&larr;</div>
  <div class="center" id="recording">
    <div id="title">Поднеси глаза к рамке и держи взгляд</div>
    <div id="frame">
      <video id="video" autoplay playsinline></video>
    </div>
    <div id="timer">7</div>
  </div>

  <div class="center" id="success" style="display:none;">
    <div id="title">Твои глаза теперь смотрят на мир вечно.</div>
    <p>Сохрани эту ссылку — только по ней ты сможешь удалить их навсегда.</p>
    <div id="qr"></div>
    <a id="deleteLink" href=""></a>
  </div>

  <div class="center" id="previewSection" style="display:none;">
    <video id="preview" controls autoplay loop></video>
    <button id="restart">ЗАПИСАТЬ ЗАНОВО</button>
    <button id="save">ОСТАВИТЬ НАВСЕГДА</button>
    <button id="download">СКАЧАТЬ НА КОМПЬЮТЕР</button>
  </div>

  <script>
    const video = document.getElementById('video');
    const timer = document.getElementById('timer');
    const recording = document.getElementById('recording');
    const previewSection = document.getElementById('previewSection');
    const success = document.getElementById('success');
    const preview = document.getElementById('preview');
    const qr = document.getElementById('qr');
    const deleteLink = document.getElementById('deleteLink');
    let recorder;
    let chunks = [];
    let stream;
    let timeoutId;
    let closedEyesTime = 0;
    const faceMesh = new FaceMesh({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4/${file}`});
    faceMesh.setOptions({maxNumFaces: 1, refineLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5});
    faceMesh.onResults(onResults);
    const camera = new Camera(video, { onFrame: async () => await faceMesh.send({image: video}), width: 512, height: 128 });
    camera.start();
    let seconds = 7;

    function onResults(results) {
      if (results.multiFaceLandmarks.length > 0) {
        const landmarks = results.multiFaceLandmarks[0];
        const leftEye = landmarks.slice(33, 42); // Примерные индексы для левого глаза
        const rightEye = landmarks.slice(362, 386); // Для правого
        const leftClosed = isEyeClosed(leftEye);
        const rightClosed = isEyeClosed(rightEye);
        if (leftClosed && rightClosed) closedEyesTime += 0.1; // Примерно 100 мс на фрейм
        else closedEyesTime = 0;
        if (closedEyesTime > 1.5 || !isEyesInFrame(landmarks) || isStrongMovement(landmarks)) {
          resetTimer();
          return;
        }
        if (seconds > 0) {
          timer.textContent = seconds;
          timeoutId = setTimeout(() => {
            seconds--;
            onResults(results); // Рекурсия для таймера
          }, 1000);
        } else {
          stopRecording();
        }
      } else {
        resetTimer();
      }
    }

    function isEyeClosed(eyeLandmarks) {
      const verticalDist = Math.abs(eyeLandmarks[1].y - eyeLandmarks[5].y); // Верх и низ глаза
      return verticalDist < 0.02; // Порог для закрытого глаза
    }

    function isEyesInFrame(landmarks) {
      const leftEyeX = landmarks[33].x; // Левое глаз
      const rightEyeX = landmarks[263].x; // Правое глаз
      return leftEyeX > 0.1 && leftEyeX < 0.4 && rightEyeX > 0.6 && rightEyeX < 0.9; // Примерно в рамке
    }

    function isStrongMovement(landmarks) {
      // Простая проверка: сравни с предыдущим кадром (нужно хранить prevLandmarks)
      return false; // Для простоты, реализуй если нужно
    }

    function resetTimer() {
      clearTimeout(timeoutId);
      seconds = 7;
      timer.textContent = 7;
    }

    function startRecording() {
      chunks = [];
      recorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
      recorder.ondataavailable = e => chunks.push(e.data);
      recorder.start();
    }

    function stopRecording() {
      recorder.stop();
      recorder.onstop = () => {
        const blob = new Blob(chunks, {type: 'video/webm'});
        preview.src = URL.createObjectURL(blob);
        recording.style.display = 'none';
        previewSection.style.display = 'block';
        document.getElementById('restart').onclick = () => {
          previewSection.style.display = 'none';
          recording.style.display = 'block';
          seconds = 7;
        };
        document.getElementById('save').onclick = () => saveVideo(blob);
        document.getElementById('download').onclick = () => downloadVideo(blob);
      };
    }

    async function saveVideo(blob) {
      const s3 = new AWS.S3({ endpoint: 'https://s3.filebase.com', accessKeyId: FILEBASE_ACCESS_KEY, secretAccessKey: FILEBASE_SECRET_KEY, signatureVersion: 'v4' });
      const params = { Bucket: 'gorgona', Key: Date.now() + '.webm', Body: blob, ACL: 'public-read' };
      const upload = await s3.upload(params).promise();
      const cid = upload.Location.split('/').pop();
      const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      await supabase.from('eyes').insert({ cid });
      const deleteKey = crypto.randomUUID();
      const deleteUrl = `https://gorgonaeyes.netlify.app/delete/${deleteKey}`;
      qr.innerHTML = `QR: (используй библиотеку для генерации QR, напр qrcode.js)`;
      deleteLink.href = deleteUrl;
      deleteLink.textContent = deleteUrl;
      previewSection.style.display = 'none';
      success.style.display = 'block';
      // Сохрани deleteKey в Supabase или другом месте для удаления
    }

    function downloadVideo(blob) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'eyes.webm';
      a.click();
    }

    navigator.mediaDevices.getUserMedia({ video: { width: 512, height: 128 } }).then(s => {
      stream = s;
      video.srcObject = s;
      startRecording(); // Начать запись сразу, но сохранять только после 7 сек
    }).catch(console.error);
  </script>
</body>
</html>
