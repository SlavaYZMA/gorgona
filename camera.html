<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Горгона — добавление глаз</title>
  <style>
    body, html { margin:0; padding:0; height:100%; background:#000; color:#fff; overflow:hidden; font-family:system-ui, sans-serif; }
    video { position:fixed; top:0; left:0; width:100%; height:100%; object-fit:cover; transform:scaleX(-1); display:none; }
    canvas { position:fixed; top:0; left:0; display:none; }
    .container { position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:30px; z-index:10; }
    .frame { width:512px; height:128px; max-width:90vw; max-height:25vh; border:4px solid #c00; border-radius:16px; background:#111; }
    .frame.good { border-color:#0f0; }
    .timer { font-size:120px; font-weight:bold; margin:0; }
    .status { font-size:24px; text-align:center; max-width:90%; }
    button { padding:16px 32px; font-size:20px; cursor:pointer; border:none; border-radius:12px; margin:10px; min-width:280px; }
    #restart { background:#900; color:white; }
    #download { background:#333; color:white; }
    #save { background:white; color:black; }
    .back { position:absolute; top:20px; left:20px; font-size:32px; opacity:0.5; text-decoration:none; color:#fff; }
  </style>
</head>
<body>

<video id="video" autoplay playsinline></video>
<canvas id="hiddenCanvas" width="512" height="128"></canvas>

<div class="container" id="step1">
  <div class="status">Поднеси глаза в рамку</div>
  <div class="frame" id="frame"></div>
  <div class="timer" id="timer">7</div>
</div>

<div class="container" id="step2" style="display:none;">
  <div class="status">Вот что будет сохранено (только глаза):</div>
  <img id="preview" style="width:512px; max-width:90vw; border:4px solid #0f0; border-radius:16px;" />
  <div>
    <button id="restart">ЗАПИСАТЬ ЕЩЁ РАЗ</button>
    <button id="download">ВЫГРУЗИТЬ НА КОМПЬЮТЕР (тест)</button>
    <button id="save">ОСТАВИТЬ НАВСЕГДА</button>
  </div>
</div>

<a href="/" class="back">←</a>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
<script>
  const video = document.getElementById('video');
  const hiddenCanvas = document.getElementById('hiddenCanvas');
  const ctx = hiddenCanvas.getContext('2d');
  const frame = document.getElementById('frame');
  const timerEl = document.getElementById('timer');
  const step1 = document.getElementById('step1');
  const step2 = document.getElementById('step2');
  const preview = document.getElementById('preview');

  let countdown = null;
  let seconds = 7;
  let finalBlob = null;

  const faceMesh = new FaceMesh({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
  faceMesh.setOptions({
    maxNumFaces: 1,
    refineLandmarks: true,
    minDetectionConfidence: 0.5,
    minTrackingConfidence: 0.5
  });

  faceMesh.onResults(onResults);

  async function startCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
      video.srcObject = stream;
      video.style.display = 'block';
      const camera = new Camera(video, { onFrame: async () => await faceMesh.send({image: video}) });
      camera.start();
    } catch (e) {
      alert('Разреши доступ к камере — это нужно только для твоих глаз, ничего не сохраняется и не уходит с телефона');
    }
  }

  function onResults(results) {
    ctx.clearRect(0, 0, 512, 128);
    ctx.fillStyle = '#000';
    ctx.fillRect(0, 0, 512, 128);

    if (results.multiFaceLandmarks && results.multiFaceLandmarks[0]) {
      const landmarks = results.multiFaceLandmarks[0];
      const leftEye = landmarks[33];   // примерные точки
      const rightEye = landmarks[263];
      const top = landmarks[159];
      const bottom = landmarks[145];

      const x1 = Math.min(leftEye.x, rightEye.x) * video.videoWidth;
      const x2 = Math.max(leftEye.x, rightEye.x) * video.videoWidth;
      const y1 = Math.min(top.y, bottom.y) * video.videoHeight;
      const y2 = Math.max(top.y, bottom.y) * video.videoHeight;

      const width = x2 - x1;
      const height = y2 - y1;
      const centerX = x1 + width / 2;
      const centerY = y1 + height / 2;

      const targetW = 512;
      const targetH = 128;
      const scale = Math.max(targetW / width, targetH / height) * 1.3;

      ctx.drawImage(
        video,
        centerX - (targetW / scale) / 2,
        centerY - (targetH / scale) / 2,
        targetW / scale,
        targetH / scale,
        0, 0, targetW, targetH
      );

      frame.classList.add('good');
      if (!countdown) startCountdown();
    } else {
      frame.classList.remove('good');
      if (countdown) clearInterval(countdown);
      countdown = null;
      seconds = 7;
      timerEl.textContent = '7';
    }
  }

  function startCountdown() {
    countdown = setInterval(() => {
      seconds--;
      timerEl.textContent = seconds;
      if (seconds <= 0) {
        clearInterval(countdown);
        finalBlob = dataURLtoBlob(hiddenCanvas.toDataURL('image/png'));
        preview.src = hiddenCanvas.toDataURL('image/png');
        step1.style.display = 'none';
        step2.style.display = 'flex';
      }
    }, 1000);
  }

  function dataURLtoBlob(dataurl) {
    const arr = dataurl.split(',');
    const mime = arr[0].match(/:(.*?);/)[1];
    const bstr = atob(arr[1]);
    let n = bstr.length;
    const u8arr = new Uint8Array(n);
    while (n--) u8arr[n] = bstr.charCodeAt(n);
    return new Blob([u8arr], {type: mime});
  }

  document.getElementById('restart').onclick = () => {
    step2.style.display = 'none';
    step1.style.display = 'flex';
    seconds = 7;
    timerEl.textContent = '7';
  };

  document.getElementById('download').onclick = () => {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(finalBlob);
    a.download = 'eyes-test.png';
    a.click();
  };

  document.getElementById('save').onclick = async () => {
    const form = new FormData();
    form.append('file', finalBlob, 'eyes.png');

    const res = await fetch('/.netlify/functions/upload', { method: 'POST', body: form });
    const data = await res.json();

    if (data.deleteUrl) {
      step2.innerHTML = `
        <div class="status">Твои глаза теперь здесь навсегда</div>
        <div style="font-size:18px; word-break:break-all; margin:20px;">
          Сохрани эту ссылку — только по ней ты сможешь их удалить:
        </div>
        <img src="https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(data.deleteUrl)}" />
        <div style="margin:20px; font-size:20px; word-break:break-all;">${data.deleteUrl}</div>
        <a href="/" style="color:#888; margin-top:40px; display:block;">← назад</a>
      `;
    }
  };

  // старт
  startCamera();
</script>
</body>
</html>
