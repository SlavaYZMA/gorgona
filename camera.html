<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Горгона — запись взгляда</title>
<style>
  :root{
    --bg:#000;--fg:#fff;--primary:#ff2d2d;--surface:rgba(255,255,255,0.04);
    --radius:16px;--gap:16px;--action-h:56px;--max-w:640px;
  }
  *,*::before,*::after{box-sizing:border-box}
  body,html{margin:0;padding:0;height:100%;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,sans-serif;overflow:hidden}
  #app{display:flex;flex-direction:column;height:100vh;padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left)}

  .topbar{padding:16px 20px;text-align:left}
  .topbar button{background:none;border:none;color:var(--fg);font-size:18px;cursor:pointer;padding:8px}

  main{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;gap:24px;overflow-y:auto}
  .canvas-wrap{position:relative;width:512px;max-width:100%;transition:opacity .4s ease}
  #visibleCanvas{display:block;width:100%;height:auto;border:5px solid #fff;border-radius:var(--radius);box-shadow:0 8px 40px rgba(255,255,255,0.12)}
  #hiddenVideo{position:absolute;opacity:0;width:1px;height:1px}

  .overlay{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:none;z-index:10}
  #countdown{font-size:120px;opacity:0;transition:opacity .3s}
  #rec{font-size:28px;opacity:0;color:#ff4444;transition:opacity .3s}

  .instruction{max-width:var(--max-w);text-align:center;font-size:18px;line-height:1.5;color:rgba(255,255,255,0.7);margin:0}

  .controls{display:flex;align-items:center;justify-content:center;gap:12px;background:var(--surface);padding:12px 20px;border-radius:var(--radius);backdrop-filter:blur(12px);max-width:var(--max-w);width:100%;transition:opacity .4s ease}
  .controls button{background:#333;color:#fff;border:none;width:44px;height:44px;border-radius:12px;font-size:24px;cursor:pointer}
  #zoomSlider{flex:1;max-width:220px;height:8px;border-radius:4px;background:#333}
  #zoomValue{min-width:50px;text-align:center;font-size:18px}
  #zoomReset{font-size:14px;padding:8px 14px;background:#222}

  .actions{position:sticky;bottom:16px;display:flex;gap:12px;padding:0 20px;justify-content:center;max-width:var(--max-w);margin:0 auto;transition:opacity .4s ease}
  .actions button{height:var(--action-h);border-radius:var(--radius);border:none;font-size:18px;font-weight:600;cursor:pointer;transition:all .15s;flex:1}
  #recordBtn{background:var(--primary);color:#fff;box-shadow:0 4px 20px rgba(255,45,45,0.4)}
  #recordBtn:active{transform:scale(0.95)}
  .btn-secondary{background:#222;color:#fff}

  /* ПРЕДПРОСМОТР */
  #previewWrap{
    position:absolute;top:0;left:0;width:100%;height:100%;
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    background:#000;opacity:0;pointer-events:none;transition:opacity .5s ease;
  }
  #previewWrap.active{opacity:1;pointer-events:all}
  #previewVideo{
    width:512px;max-width:90vw;height:128px;border:5px solid #fff;border-radius:var(--radius);
    box-shadow:0 8px 40px rgba(255,255,255,0.12);object-fit:contain;background:#000;
  }
  .preview-actions{
    margin-top:32px;display:flex;gap:16px;width:100%;max-width:512px;padding:0 20px;
  }
  .preview-actions button{
    flex:1;height:var(--action-h);border-radius:var(--radius);font-size:18px;font-weight:600;
  }

  @media(min-width:768px){
    .controls{padding:14px 28px}
    .actions{gap:20px}
    .actions button{flex:none;min-width:160px}
  }
</style>
</head>
<body>

<div id="app">
  <header class="topbar">
    <button id="backBtnTop">Назад</button>
  </header>

  <main>
    <div class="canvas-wrap" id="cameraView">
      <video id="hiddenVideo" autoplay playsinline muted></video>
      <canvas id="visibleCanvas" width="512" height="128"></canvas>
      <div id="countdown" class="overlay">3</div>
      <div id="rec" class="overlay">REC</div>
    </div>

    <p class="instruction">
      Поднесите устройство так, чтобы <strong>глаза</strong> полностью заполнили рамку.<br>
      Используйте зум для точной подгонки.
    </p>

    <div class="controls" id="zoomControls">
      <button id="zoomOut">−</button>
      <input type="range" id="zoomSlider" min="1.0" max="3.0" step="0.1" value="1.6">
      <span id="zoomValue">1.6×</span>
      <button id="zoomIn">+</button>
      <button id="zoomReset">Reset</button>
    </div>
  </main>

  <footer class="actions">
    <button id="backBtn" class="btn-secondary">Назад</button>
    <button id="recordBtn">Записать</button>
    <div style="flex:1"></div>
  </footer>

  <!-- ПРЕДПРОСМОТР -->
  <div id="previewWrap">
    <video id="previewVideo" loop muted playsinline></video>
    <div class="preview-actions">
      <button onclick="accept()" style="background:var(--primary)">Далее</button>
      <button onclick="retake()" style="background:#333">Заново</button>
      <button onclick="history.back()" style="background:#222">Назад</button>
    </div>
  </div>
</div>

<script>
const video = document.getElementById('hiddenVideo');
const canvas = document.getElementById('visibleCanvas');
const ctx = canvas.getContext('2d');
let stream = null;
let zoomFactor = 1.6;

// зум
const zoomSlider = document.getElementById('zoomSlider');
const zoomValue = document.getElementById('zoomValue');
const zoomIn = document.getElementById('zoomIn');
const zoomOut = document.getElementById('zoomOut');
const zoomReset = document.getElementById('zoomReset');

zoomSlider.oninput = () => { zoomFactor = parseFloat(zoomSlider.value); zoomValue.textContent = zoomFactor.toFixed(1)+'×'; };
zoomIn.onclick   = () => { zoomFactor = Math.min(3.0, zoomFactor+0.1); updateZoomUI(); };
zoomOut.onclick  = () => { zoomFactor = Math.max(1.0, zoomFactor-0.1); updateZoomUI(); };
zoomReset.onclick = () => { zoomFactor = 1.6; updateZoomUI(); };
function updateZoomUI(){ zoomSlider.value = zoomFactor; zoomValue.textContent = zoomFactor.toFixed(1)+'×'; }

// камера
navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false })
  .then(s => { stream = s; video.srcObject = stream; video.play(); drawLoop(); })
  .catch(() => alert("Ошибка камеры. Разреши доступ."));

// зеркальный + зум drawLoop
function drawLoop(){
  if(video.readyState === video.HAVE_ENOUGH_DATA){
    const baseScale = Math.max(canvas.width / video.videoWidth, canvas.height / video.videoHeight);
    const finalScale = baseScale * zoomFactor;
    const srcW = canvas.width / finalScale;
    const srcH = canvas.height / finalScale;
    const srcX = (video.videoWidth - srcW)/2;
    const srcY = (video.videoHeight - srcH)/2;

    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.save();
    ctx.translate(canvas.width,0);
    ctx.scale(-1,1);
    ctx.drawImage(video, srcX, srcY, srcW, srcH, 0, 0, canvas.width, canvas.height);
    ctx.restore();
  }
  requestAnimationFrame(drawLoop);
}

// запись
let recorder = null;
let chunks = [];

function startRecording(){
  document.getElementById('zoomControls').style.pointerEvents='none';
  document.getElementById('recordBtn').disabled = true;

  const streamFromCanvas = canvas.captureStream(30);
  const options = [{mimeType:'video/webm;codecs=vp9'},{mimeType:'video/webm;codecs=vp8'},{mimeType:'video/webm'}];
  let selected = options.find(opt => MediaRecorder.isTypeSupported(opt.mimeType));

  recorder = new MediaRecorder(streamFromCanvas, selected);

  recorder.ondataavailable = e => chunks.push(e.data);
  recorder.onstop = () => {
    const blob = new Blob(chunks, {type: selected?.mimeType || 'video/webm'});
    showPreview(blob);
    chunks = [];
  };

  let count = 3;
  const cd = document.getElementById('countdown');
  cd.style.opacity = 1;
  cd.textContent = count;
  const iv = setInterval(() => {
    count--;
    if(count>0) cd.textContent = count;
    else{
      clearInterval(iv);
      cd.style.opacity = 0;
      document.getElementById('rec').style.opacity = 1;
      recorder.start();
      setTimeout(() => {
        recorder.stop();
        document.getElementById('rec').style.opacity = 0;
      }, 3000);
    }
  },1000);
}

// ПРЕДПРОСМОТР — теперь красиво и плавно
function showPreview(blob){
  const previewWrap = document.getElementById('previewWrap');
  const previewVideo = document.getElementById('previewVideo');
  previewVideo.src = URL.createObjectURL(blob);
  previewVideo.play();
  previewWrap.classList.add('active');

  // скрываем всё остальное
  document.getElementById('cameraView').style.opacity = '0';
  document.querySelector('.instruction').style.opacity = '0';
  document.getElementById('zoomControls').style.opacity = '0';
  document.querySelector('.actions').style.opacity = '0';
  document.querySelector('.topbar').style.opacity = '0';
}

function retake(){
  location.reload();
}

async function accept(){
  const form = new FormData();
  form.append('file', window.currentBlob, 'eyes.webm');

  const resp = await fetch('/.netlify/functions/add-eyes', {method:'POST', body:form});
  const json = await resp.json();

  if(json.deleteUrl){
    alert("Взгляд добавлен.\n\nСсылка для удаления:\n"+json.deleteUrl);
    location.href = 'canvas.html';
  }else{
    alert('Ошибка: '+JSON.stringify(json));
  }
}

// хранение blob для отправки
let currentBlob = null;
function showPreview(blob){
  currentBlob = blob;
  // ... весь код выше
}

// кнопки
document.getElementById('recordBtn').onclick = startRecording;
document.getElementById('backBtn').onclick = () => history.back();
document.getElementById('backBtnTop').onclick = () => history.back();
</script>
</body>
</html>
