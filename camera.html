<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Горгона — запись взгляда</title>
<style>
  body,html{margin:0;padding:0;height:100%;background:#000;color:#fff;font-family:system-ui,sans-serif;overflow:hidden;position:relative}
  #container{position:relative;width:100vw;height:100vh}
  #hiddenVideo{position:absolute;opacity:0;pointer-events:none}
  #visibleCanvas{display:block;margin:0 auto;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);border:5px solid white;border-radius:16px;box-shadow:0 0 60px rgba(255,255,255,0.3)}
  
  .controls{position:absolute;bottom:110px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.7);padding:12px 20px;border-radius:16px;display:flex;align-items:center;gap:12px;font-size:18px}
  .controls button{background:#333;color:#fff;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-size:20px}
  .controls input[type=range]{width:200px}
  
  .text{position:absolute;bottom:190px;left:50%;transform:translateX(-50%);font-size:20px;text-align:center;width:90%;line-height:1.4}
  button{position:absolute;bottom:30px;padding:14px 32px;font-size:18px;border:none;border-radius:12px;cursor:pointer;transform:translateX(-50%)}
  #recordBtn{left:50%;background:#c00;color:white}
  #backBtn{left:80px;background:#333;color:white}
  #countdown{font-size:120px;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:none;opacity:0;z-index:10}
  #rec{font-size:24px;position:absolute;top:80px;left:50%;transform:translateX(-50%);opacity:0;color:#f44;z-index:10}
  #previewVideo{display:block;margin:0 auto;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);border:5px solid white;border-radius:16px}
</style>
</head>
<body>

<div id="container">
  <video id="hiddenVideo" autoplay playsinline muted></video>
  <canvas id="visibleCanvas" width="512" height="128"></canvas>

  <div class="text" id="instruction">
    Поднесите устройство так, чтобы <b>глаза</b> полностью заполнили белую рамку.<br>
    Используйте зум ниже для точной подгонки.
  </div>

  <div class="controls" id="zoomControls">
    <button id="zoomOut">−</button>
    <input type="range" id="zoomSlider" min="1.0" max="3.0" step="0.1" value="1.6">
    <span id="zoomValue">1.6×</span>
    <button id="zoomIn">+</button>
    <button id="zoomReset" style="margin-left:20px;font-size:14px;padding:8px 12px">Reset</button>
  </div>

  <button id="recordBtn">Записать</button>
  <button id="backBtn" onclick="history.back()">Назад</button>

  <div id="countdown">3</div>
  <div id="rec">REC</div>

  <video id="previewVideo" loop muted playsinline style="display:none"></video>
</div>

<script>
const video = document.getElementById('hiddenVideo');
const canvas = document.getElementById('visibleCanvas');
const ctx = canvas.getContext('2d');
let stream = null;
let zoomFactor = 1.6;

// === Зум-контролы ===
const zoomSlider = document.getElementById('zoomSlider');
const zoomValue = document.getElementById('zoomValue');
const zoomIn = document.getElementById('zoomIn');
const zoomOut = document.getElementById('zoomOut');
const zoomReset = document.getElementById('zoomReset');

zoomSlider.oninput = () => { zoomFactor = parseFloat(zoomSlider.value); zoomValue.textContent = zoomFactor.toFixed(1)+'×'; };
zoomIn.onclick   = () => { zoomFactor = Math.min(3.0, zoomFactor+0.1); updateZoomUI(); };
zoomOut.onclick  = () => { zoomFactor = Math.max(1.0, zoomFactor-0.1); updateZoomUI(); };
zoomReset.onclick= () => { zoomFactor = 1.6; updateZoomUI(); };

function updateZoomUI() {
  zoomSlider.value = zoomFactor;
  zoomValue.textContent = zoomFactor.toFixed(1)+'×';
}

// === Запуск камеры ===
navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false })
  .then(s => {
    stream = s;
    video.srcObject = stream;
    video.play();
    drawLoop();
  })
  .catch(err => alert("Ошибка камеры. Разреши доступ."));

// === ЗЕРКАЛЬНЫЙ drawLoop (всегда включён) ===
function drawLoop() {
  if (video.readyState === video.HAVE_ENOUGH_DATA) {
    const baseScale = Math.max(canvas.width / video.videoWidth, canvas.height / video.videoHeight);
    const finalScale = baseScale * zoomFactor;

    const srcW = canvas.width / finalScale;
    const srcH = canvas.height / finalScale;
    const srcX = (video.videoWidth - srcW) / 2;
    const srcY = (video.videoHeight - srcH) / 2;

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    ctx.save();
    ctx.translate(canvas.width, 0);
    ctx.scale(-1, 1);  // зеркалирование по горизонтали
    ctx.drawImage(video, srcX, srcY, srcW, srcH, 0, 0, canvas.width, canvas.height);
    ctx.restore();
  }
 16}
  requestAnimationFrame(drawLoop);
}

// === Запись 3 секунды из canvas (уже зеркального) ===
let recorder = null;
let chunks = [];

function startRecording() {
  document.getElementById('zoomControls').style.pointerEvents = 'none';
  document.getElementById('recordBtn').disabled = true;

  const streamFromCanvas = canvas.captureStream(30);
  recorder = new MediaRecorder(streamFromCanvas, { mimeType: 'video/webm;codecs=vp9' });

  recorder.ondataavailable = e => chunks.push(e.data);
  recorder.onstop = () => {
    const blob = new Blob(chunks, { type: 'video/webm' });
    showPreview(blob);
    chunks = [];
  };

  let count = 3;
  const cd = document.getElementById('countdown');
  cd.style.opacity = 1;
  cd.textContent = count;
  const iv = setInterval(() => {
    count--;
    if(count > 0) cd.textContent = count;
    else {
      clearInterval(iv);
      cd.style.opacity = 0;
      document.getElementById('rec').style.opacity = 1;
      recorder.start();
      setTimeout(() => {
        recorder.stop();
        document.getElementById('rec').style.opacity = 0;
      }, 3000);
    }
  }, 1000);
}

// === Превью и отправка ===
function showPreview(blob) {
  const preview = document.getElementById('previewVideo');
  preview.src = URL.createObjectURL(blob);
  preview.style.display = 'block';
  preview.play();

  canvas.style.display = 'none';
  document.getElementById('instruction').style.display = 'none';
  document.getElementById('recordBtn').style.display = 'none';
  document.getElementById('zoomControls').style.display = 'none';

  const div = document.createElement('div');
  div.innerHTML = `
    <button onclick="accept()">Далее</button>
    <button onclick="retake()" style="margin-left:20px;background:#333">Записать заново</button>
    <button onclick="history.back()" style="margin-left:20px;background:#333">Назад</button>
  `;
  div.style.position='absolute';div.style.bottom='40px';div.style.left='50%';div.style.transform='translateX(-50%)';
  document.body.appendChild(div);

  window.currentBlob = blob;
}

function retake() { location.reload(); }

async function accept() {
  const form = new FormData();
  form.append('file', window.currentBlob, 'eyes.webm');

  const resp = await fetch('/.netlify/functions/add-eyes', { method: 'POST', body: form });
  const json = await resp.json();

  if(json.deleteUrl){
    alert("Взгляд добавлен.\n\nСсылка для удаления:\n" + json.deleteUrl);
    location.href = 'canvas.html';
  } else {
    alert('Ошибка: ' + JSON.stringify(json));
  }
}

document.getElementById('recordBtn').onclick = startRecording;
</script>
</body>
</html>
