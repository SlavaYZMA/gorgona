<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Горгона — запись глаз</title>
  <style>
    body,html{margin:0;padding:0;height:100%;background:#000;color:#fff;font-family:system-ui,sans-serif;overflow:hidden}
    video{width:100%;height:100%;object-fit:cover;transform:scaleX(-1)}
    canvas{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) scaleX(-1);border:4px solid #fff;border-radius:12px;box-shadow:0 0 40px rgba(255,255,255,0.7);pointer-events:none}
    #info{position:absolute;bottom:100px;left:0;width:100%;text-align:center;font-size:24px;opacity:0.8}
    #timer{position:absolute;top:20px;left:0;width:100%;text-align:center;font-size:64px;font-weight:bold;color:#0f0;text-shadow:0 0 20px #000;opacity:0}
    button{position:fixed;bottom:20px;width:calc(50% - 20px);padding:20px;font-size:22px;border:none;border-radius:12px;cursor:pointer;z-index:10}
    #retry{left:10px;background:#900;color:#fff}
    #send{right:10px;background:#090;color:#fff}
    #preview{display:none;width:100%;height:100%;object-fit:contain;background:#000}
  </style>
</head>
<body>

<video id="video" autoplay playsinline muted></video>
<canvas id="frame" width="512" height="128"></canvas>
<div id="timer">3</div>
<div id="info">Поднеси глаза точно в рамку<br>Держи неподвижно 3 секунды</div>
<button id="retry" style="display:none">Перезаписать</button>
<button id="send" style="display:none">Отправить в Горгону</button>
<video id="preview" controls loop></video>

<script>
  const video = document.getElementById('video');
  const canvas = document.getElementById('frame');
  const ctx = canvas.getContext('2d');
  const timer = document.getElementById('timer');
  const info = document.getElementById('info');
  const preview = document.getElementById('preview');
  const retry = document.getElementById('retry');
  const send = document.getElementById('send');

  let stream, recorder, chunks = [], countdown;

  async function start() {
    stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}, audio:false});
    video.srcObject = stream;
    drawLoop();
  }

  function drawLoop() {
    ctx.drawImage(video, (video.videoWidth-512)/2, (video.videoHeight-128)/2, 512, 128, 0, 0, 512, 128);
    requestAnimationFrame(drawLoop);
  }

  // Ждём 3 секунды неподвижности (просто по таймеру после загрузки)
  setTimeout)
  setTimeout(() => {
    timer.style.opacity = 1;
    let sec = 3;
    const int = setInterval(() => {
      sec--;
      timer.textContent = sec;
      if (sec <= 0) {
        clearInterval(int);
        timer.textContent = "Запись!";
        startRecording();
      }
    }, 1000);
  }, 1500);

  function startRecording() {
    chunks = [];
    recorder = new MediaRecorder(stream, {mimeType: MediaRecorder.isTypeSupported('video/webm;codecs=vp9') ? 'video/webm;codecs=vp9' : 'video/mp4'});
    recorder.ondataavailable = e => chunks.push(e.data);
    recorder.onstop = () => {
      const blob = new Blob(chunks, {type: 'video/webm'});
      const url = URL.createObjectURL(blob);
      preview.src = url;
      preview.style.display = 'block';
      video.style.display = 'none';
      canvas.style.display = 'none';
      timer.style.display = 'none';
      info.textContent = "Готово!";
      retry.style.display = 'block';
      send.style.display = 'block';

      retry.onclick = () => location.reload();
      send.onclick = () => upload(blob);
    };
    recorder.start();
    setTimeout(() => recorder.stop(), 5000);
  }

  async function upload(blob) {
    // Это мы сделаем в следующем шаге через Netlify Function
    alert("Видео записано! Ждём upload-функцию в следующем файле");
  }

  start();
</script>
</body>
</html>
