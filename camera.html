<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Горгона — запись глаз</title>
  <style>
    body,html{margin:0;padding:0;height:100%;background:#000;color:#fff;font-family:system-ui,sans-serif;overflow:hidden}
    #container{position:relative;width:100vw;height:100vh;background:#000}
    #video{position:absolute;width:100%;height:100%;object-fit:cover;transform:scaleX(-1);opacity:0.3}
    #mask{position:absolute;top:0;left:0;width:100%;height:100%;background:#000;z-index:1}
    #frame{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:512px;height:128px;border:5px solid #fff;border-radius:16px;overflow:hidden;z-index:2;box-shadow:0 0 60px rgba(255,255,255,0.8)}
    #timer{position:absolute;top:80px;left:0;width:100%;text-align:center;font-size:72px;font-weight:bold;color:#0f0;text-shadow:0 0 20px #000;z-index:3;opacity:0}
    #info{position:absolute;bottom:120px;left:0;width:100%;text-align:center;font-size:26px;z-index:3}
    button{position:fixed;bottom:20px;width:calc(50% - 20px);padding:20px;font-size:22px;border:none;border-radius:12px;cursor:pointer;z-index:10}
    #retry{left:10px;background:#900;color:#fff;display:none}
    #send{right:10px;background:#090;color:#fff;display:none}
  </style>
</head>
<body>

<div id="container">
  <video id="video" autoplay playsinline muted></video>
  <div id="mask"></div>
  <div id="frame">
    <canvas id="canvas" width="512" height="128"></canvas>
  </div>
  <div id="timer">3</div>
  <div id="info">Поднеси глаза в рамку<br>Держи неподвижно 3 секунды</div>
  <button id="retry">Перезаписать</button>
  <button id="send">Отправить в Горгону</button>
</div>

<script>
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const timer = document.getElementById('timer');
  const info = document.getElementById('info');
  const retry = document.getElementById('retry');
  const send = document.getElementById('send');

  let stream, recorder, chunks = [];

  async function start() {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "user", width: {ideal: 1920}, height: {ideal: 1080} },
      audio: false
    });
    video.srcObject = stream;
    video.play();

    // Рисуем только внутри рамки
    function draw() {
      ctx.save();
      ctx.scale(-1, 1); // зеркалим
      ctx.drawImage(video, -512, 0);
      ctx.restore();
      requestAnimationFrame(draw);
    }
    draw();

    // Через 1.5 сек после запуска — начинаем отсчёт
    setTimeout(() => {
      timer.style.opacity = 1;
      let sec = 3;
      const interval = setInterval(() => {
        sec--;
        timer.textContent = sec > 0 ? sec : "Запись!";
        if (sec <= -1) {
          clearInterval(interval);
          startRecording();
        }
      }, 1000);
    }, 1500);
  }

  function startRecording() {
    chunks = [];
    const mime = MediaRecorder.isTypeSupported('video/webm;codecs=vp9') 
                 ? 'video/webm;codecs=vp9' 
                 : 'video/webm';
    
    recorder = new MediaRecorder(stream, { mimeType: mime });
    recorder.ondataavailable = e => chunks.push(e.data);
    recorder.onstop = () => {
      const blob = new Blob(chunks, { type: mime });
      const url = URL.createObjectURL(blob);
      
      // Превью — только глаза
      const prev = document.createElement('video');
      prev.src = url;
      prev.controls = true;
      prev.loop = true;
      prev.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:512px;height:128px;border:5px solid #fff;border-radius:16px;z-index:100';
      document.body.appendChild(prev);
      
      info.textContent = "Готово. Твои глаза записаны навсегда.";
      retry.style.display = 'block';
      send.style.display = 'block';
      
      retry.onclick = () => location.reload();
      send.onclick = () => uploadToGorgona(blob);
    };
    recorder.start();
    setTimeout(() => recorder.stop(), 5000);
  }

  function uploadToGorgona(blob) {
    alert("Видео записано — только глаза.\nСкоро добавим реальную загрузку в Filebase.");
  }

  start();
</script>
</body>
</html>
