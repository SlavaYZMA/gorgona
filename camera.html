<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Горгона — запись взгляда</title>
<style>
  body,html{margin:0;padding:0;height:100%;background:#000;color:#fff;font-family:system-ui,sans-serif;overflow:hidden}
  #video{width:100vw;height:100vh;object-fit:cover;transform:scaleX(-1)}
  #overlay{position:fixed;inset:0;pointer-events:none;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:30px}
  #frame{width:512px;height:128px;border:5px solid white;border-radius:16px;box-shadow:0 0 50px rgba(255,255,255,0.3)}
  #countdown{font-size:120px;font-weight:900;opacity:0}
  #rec{color:#ff3333;font-size:32px;font-weight:bold;opacity:0}
  .text{font-size:18px;text-align:center;max-width:90%;line-height:1.5}
  #controls{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);display:flex;gap:20px;z-index:10}
  button{background:#222;color:#fff;border:none;padding:16px 32px;border-radius:12px;font-size:18px;cursor:pointer}
  #recordBtn{background:#c00;box-shadow:0 4px 20px rgba(255,0,0,0.5)}
</style>
</head>
<body>

<video id="video" autoplay playsinline muted></video>

<div id="overlay">
  <div id="frame"></div>
  <div id="countdown">3</div>
  <div id="rec">● REC</div>
  <div class="text">
    Поднесите глаза точно в рамку<br>
    Держите взгляд 3 секунды
  </div>
</div>

<div id="controls">
  <button onclick="history.back()">Назад</button>
  <button id="recordBtn">Записать взгляд</button>
</div>

<script>
const video = document.getElementById('video');
let recorder = null;
let chunks = [];

// камера
navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false })
  .then(stream => {
    video.srcObject = stream;
  })
  .catch(() => alert("Ошибка камеры. Разреши доступ."));

// проверка: есть ли глаза в рамке?
function hasEyes() {
  const canvas = document.createElement('canvas');
  canvas.width = 512;
  canvas.height = 128;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, (video.videoWidth-512)/2, (video.videoHeight-128)/2, 512, 128, 0, 0, 512, 128);
  const data = ctx.getImageData(0, 0, 512, 128).data;
  let dark = 0;
  for (let i = 0; i < data.length; i += 12) {
    const brightness = (data[i] + data[i+1] + data[i+2]) / 3;
    if (brightness < 100) dark++;
  }
  return dark > 5000;
}

// запись 3-секундного видео
document.getElementById('recordBtn').onclick = () => {
  if (recorder?.state === "recording") return;
  
  document.getElementById('recordBtn').disabled = true;
  chunks = [];

  const stream = video.captureStream(30);
  const options = { mimeType: 'video/webm;codecs=vp9' };
  if (!MediaRecorder.isTypeSupported(options.mimeType)) {
    options.mimeType = 'video/webm;codecs=vp8';
  }
  if (!MediaRecorder.isTypeSupported(options.mimeType)) {
    options.mimeType = 'video/webm';
  }

  recorder = new MediaRecorder(stream, options);

  let sec = 3;
  const cd = document.getElementById('countdown');
  cd.style.opacity = 1;
  cd.textContent = sec;

  const checker = setInterval(() => {
    if (!hasEyes()) {
      recorder.stop();
      clearInterval(checker);
      cd.style.opacity = 0;
      document.getElementById('recordBtn').disabled = false;
      alert("Глаза вышли из рамки. Попробуй ещё раз.");
      return;
    }
    sec--;
    cd.textContent = sec;
    if (sec <= 0) {
      clearInterval(checker);
      cd.style.opacity = 0;
      document.getElementById('rec').style.opacity = 1;
    }
  }, 1000);

  recorder.ondataavailable = e => chunks.push(e.data);
  recorder.onstop = () => {
    document.getElementById('rec').style.opacity = 0;
    const blob = new Blob(chunks, { type: 'video/webm' });
    if (blob.size < 30000) { // <30 КБ — явно мусор
      alert("Видео слишком маленькое. Попробуй ещё раз.");
      document.getElementById('recordBtn').disabled = false;
      return;
    }
    uploadVideo(blob);
  };

  recorder.start();
  setTimeout(() => {
    if (recorder.state === "recording") recorder.stop();
  }, 4000);
};

async function uploadVideo(blob) {
  const form = new FormData();
  form.append('file', blob, 'eyes.webm');

  const resp = await fetch('/.netlify/functions/add-eyes', {
    method: 'POST',
    body: form
  });
  const json = await resp.json();

  if (json.deleteUrl) {
    alert("Взгляд добавлен навсегда.\n\nСсылка для удаления (СОХРАНИ ЕЁ!):\n" + json.deleteUrl);
    location.href = 'canvas.html';
  } else {
    alert("Ошибка: " + JSON.stringify(json));
    document.getElementById('recordBtn').disabled = false;
  }
}
</script>
</body>
</html>
