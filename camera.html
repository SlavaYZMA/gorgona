<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Горгона — запись взгляда</title>
  <style>
    :root{--bg:#000;--fg:#fff;--muted:rgba(255,255,255,0.7);--primary:#ff2d2d;--surface:rgba(255,255,255,0.04);--radius:16px;--gap:16px;--action-height:56px;--max-width:640px;}
    *,*::before,*::after{box-sizing:border-box}
    body,html{margin:0;padding:0;height:100%;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,sans-serif;overflow:hidden}
    #app{display:flex;flex-direction:column;height:100vh;padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left)}
    .topbar{padding:16px 20px;text-align:left}
    .topbar button{background:none;border:none;color:var(--fg);font-size:18px;cursor:pointer;padding:8px}
    main{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;gap:24px;overflow-y:auto}
    .canvas-wrap{position:relative;width:512px;max-width:100%}
    #visibleCanvas{display:block;width:100%;height:auto;border:5px solid white;border-radius:var(--radius);box-shadow:0 8px 40px rgba(255,255,255,0.12)}
    #hiddenVideo{position:absolute;opacity:0;pointer-events:none;width:1px;height:1px}
    .overlay-count,.overlay-rec{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:none;font-weight:bold;z-index:10}
    #countdown{font-size:120px;opacity:0}
    #rec{font-size:28px;opacity:0;color:#ff4444}
    .instruction{max-width:var(--max-width);text-align:center;font-size:18px;line-height:1.5;color:var(--muted);margin:0}
    .controls{display:flex;align-items:center;justify-content:center;gap:12px;background:var(--surface);padding:12px 20px;border-radius:var(--radius);backdrop-filter:blur(10px);max-width:var(--max-width);width:100%}
    .controls button{background:#333;color:#fff;border:none;width:44px;height:44px;border-radius:12px;font-size:24px;cursor:pointer}
    #zoomSlider{flex:1;max-width:220px;height:8px;border-radius:4px;background:#333}
    #zoomValue{min-width:50px;text-align:center;font-size:18px}
    #zoomReset{font-size:14px;padding:8px 14px;background:#222}
    .actions{position:sticky;bottom:16px;display:flex;gap:12px;padding:0 20px;justify-content:center;max-width:var(--max-width);margin:0 auto}
    .actions button{flex:1;height:var(--action-height);border-radius:var(--radius);border:none;font-size:18px;font-weight:600;cursor:pointer;transition:all 0.15s}
    #recordBtn{background:var(--primary);color:#fff;box-shadow:0 4px 20px rgba(255,45,45,0.4)}
    #recordBtn:active{transform:scale(0.95)}
    .btn-secondary{background:#222;color:#fff}
    #previewVideo{max-width:90vw;max-height:60vh;border:5px solid white;border-radius:var(--radius)}
    .preview-actions{display:flex;gap:12px;justify-content:center;width:100%;max-width:var(--max-width)}
    @media(min-width:768px){.controls{padding:14px 28px}.actions{gap:20px}.actions button{flex:none;min-width:160px}}
  </style>
</head>
<body>
  <div id="app">
    <header class="topbar">
      <button id="backBtnTop" aria-label="Назад">Назад</button>
    </header>
    <main>
      <div class="canvas-wrap">
        <video id="hiddenVideo" autoplay playsinline muted></video>
        <canvas id="visibleCanvas" width="512" height="128"></canvas>
        <div id="countdown" class="overlay-count">3</div>
        <div id="rec" class="overlay-rec">REC</div>
      </div>
      <p class="instruction">Поднесите устройство так, чтобы <strong>глаза</strong> полностью заполнили рамку.<br>Используйте зум для точной подгонки.</p>
      <div class="controls" id="zoomControls">
        <button id="zoomOut" aria-label="Уменьшить зум">−</button>
        <input type="range" id="zoomSlider" min="1.0" max="3.0" step="0.1" value="1.6" aria-label="Зум">
        <span id="zoomValue" aria-live="polite">1.6×</span>
        <button id="zoomIn" aria-label="Увеличить зум">+</button>
        <button id="zoomReset">Reset</button>
      </div>
    </main>
    <footer class="actions">
      <button id="backBtn" class="btn-secondary">Назад</button>
      <button id="recordBtn" class="btn-primary">Записать</button>
      <div style="flex:1"></div>
    </footer>
    <video id="previewVideo" loop muted playsinline style="display:none"></video>
  </div>

  <script>
    const video = document.getElementById('hiddenVideo');
    const canvas = document.getElementById('visibleCanvas');
    const ctx = canvas.getContext('2d');
    let stream = null;
    let zoomFactor = 1.6;
    const zoomSlider = document.getElementById('zoomSlider');
    const zoomValue = document.getElementById('zoomValue');
    const zoomIn = document.getElementById('zoomIn');
    const zoomOut = document.getElementById('zoomOut');
    const zoomReset = document.getElementById('zoomReset');

    zoomSlider.oninput = () => {
      zoomFactor = parseFloat(zoomSlider.value);
      zoomValue.textContent = zoomFactor.toFixed(1) + '×';
    };
    zoomIn.onclick = () => {
      zoomFactor = Math.min(3.0, zoomFactor + 0.1);
      updateZoomUI();
    };
    zoomOut.onclick = () => {
      zoomFactor = Math.max(1.0, zoomFactor - 0.1);
      updateZoomUI();
    };
    zoomReset.onclick = () => {
      zoomFactor = 1.6;
      updateZoomUI();
    };
    function updateZoomUI() {
      zoomSlider.value = zoomFactor;
      zoomValue.textContent = zoomFactor.toFixed(1) + '×';
    }

    // камера
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false })
      .then(s => {
        stream = s;
        video.srcObject = stream;
        video.play();
        drawLoop();
      })
      .catch(() => alert("Ошибка камеры. Разреши доступ."));

    function drawLoop() {
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        const baseScale = Math.max(canvas.width / video.videoWidth, canvas.height / video.videoHeight);
        const finalScale = baseScale * zoomFactor;
        const srcW = canvas.width / finalScale;
        const srcH = canvas.height / finalScale;
        const srcX = (video.videoWidth - srcW) / 2;
        const srcY = (video.videoHeight - srcH) / 2;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.save();
        ctx.translate(canvas.width, 0);
        ctx.scale(-1, 1);
        ctx.drawImage(video, srcX, srcY, srcW, srcH, 0, 0, canvas.width, canvas.height);
        ctx.restore();
      }
      requestAnimationFrame(drawLoop);
    }

    // проверка глаз
    function hasEyes() {
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = 512;
      tempCanvas.height = 128;
      const tempCtx = tempCanvas.getContext('2d');
      tempCtx.drawImage(video, (video.videoWidth - 512) / 2, (video.videoHeight - 128) / 2, 512, 128, 0, 0, 512, 128);
      const data = tempCtx.getImageData(0, 0, 512, 128).data;
      let dark = 0;
      for (let i = 0; i < data.length; i += 4) {
        const brightness = (data[i] + data[i + 1] + data[i + 2]) / 3;
        if (brightness < 100) dark++;
      }
      return dark > 5000;
    }

    // запись
    let recorder = null;
    let chunks = [];
    document.getElementById('recordBtn').onclick = startRecording;

    function startRecording() {
      document.getElementById('zoomControls').style.pointerEvents = 'none';
      document.getElementById('recordBtn').disabled = true;
      chunks = [];

      const streamFromCanvas = canvas.captureStream(30);
      const options = [
        { mimeType: 'video/webm;codecs=vp9' },
        { mimeType: 'video/webm;codecs=vp8' },
        { mimeType: 'video/webm' }
      ];
      let selected = options.find(opt => MediaRecorder.isTypeSupported(opt.mimeType)) || options[0];

      recorder = new MediaRecorder(streamFromCanvas, selected);

      recorder.ondataavailable = e => chunks.push(e.data);
      recorder.onstop = () => {
        const blob = new Blob(chunks, { type: selected.mimeType || 'video/webm' });
        if (blob.size < 50000) { // <50 КБ — мусор
          alert('Видео слишком короткое. Попробуй ещё раз.');
          document.getElementById('recordBtn').disabled = false;
          document.getElementById('zoomControls').style.pointerEvents = 'auto';
          return;
        }
        showPreview(blob);
        chunks = [];
      };

      let count = 3;
      const cd = document.getElementById('countdown');
      cd.style.opacity = 1;
      cd.textContent = count;
      const iv = setInterval(() => {
        if (!hasEyes()) {
          clearInterval(iv);
          recorder.stop();
          cd.style.opacity = 0;
          alert('Глаза вышли из рамки. Попробуй ещё раз.');
          document.getElementById('recordBtn').disabled = false;
          document.getElementById('zoomControls').style.pointerEvents = 'auto';
          return;
        }
        count--;
        if (count > 0) cd.textContent = count;
        else {
          clearInterval(iv);
          cd.style.opacity = 0;
          document.getElementById('rec').style.opacity = 1;
          recorder.start();
          setTimeout(() => {
            if (recorder.state === 'recording') recorder.stop();
          }, 3000);
        }
      }, 1000);
    }

    function showPreview(blob) {
      const preview = document.getElementById('previewVideo');
      preview.src = URL.createObjectURL(blob);
      preview.style.display = 'block';
      preview.play();
      canvas.style.display = 'none';
      document.querySelector('.instruction').style.display = 'none';
      document.getElementById('recordBtn').style.display = 'none';
      document.getElementById('zoomControls').style.display = 'none';
      document.querySelector('.topbar').style.display = 'none';

      const div = document.createElement('div');
      div.className = 'actions preview-actions';
      div.innerHTML = `
        <button onclick="acceptVideo()" style="flex:1;height:56px;background:var(--primary);color:#fff;border-radius:12px">Далее</button>
        <button onclick="retake()" style="flex:1;height:56px;background:#333;margin:0 12px;border-radius:12px">Заново</button>
        <button onclick="history.back()" style="flex:1;height:56px;background:#222;border-radius:12px">Назад</button>
      `;
      document.body.appendChild(div);
      window.currentBlob = blob;  // Глобал для acceptVideo
    }

    function retake() {
      location.reload();
    }

    async function acceptVideo() {
      const form = new FormData();
      form.append('file', window.currentBlob, 'eyes.webm');

      const resp = await fetch('/.netlify/functions/add-eyes', { method: 'POST', body: form });
      if (!resp.ok) {
        alert('Ошибка сервера: ' + resp.status + ' ' + resp.statusText);
        return;
      }
      const json = await resp.json();

      if (json.deleteUrl) {
        alert("Взгляд добавлен.\n\nСсылка для удаления:\n" + json.deleteUrl);
        location.href = 'canvas.html';
      } else {
        alert('Ошибка: ' + JSON.stringify(json));
      }
    }

    // кнопки назад
    document.getElementById('backBtn').onclick = () => history.back();
    document.getElementById('backBtnTop').onclick = () => history.back();
  </script>
</body>
</html>
